# ATLAS-BM

Collection of benchmarks for ROOT's `TTree` and `RNTuple` in ATLAS `DAOD_PHYS/LITE`.

## General project structure

This repository contains three main directories of interest for running benchmarks and analysing their results: `scripts/` which contains scripts to collect the necessary DAODs for running the benchmarks, `benchmarks/` which runs the benchmarks and saves their results, and `macros` which contains the necessary ROOT macros for analysing and plotting the benchmark results.

The files collected and generated by the scripts in `scripts/` are by default saved in the `data/` directory (which will be created if it does not yet exist).

The results collected from the benchmarks are by default saved in the `results/` directory (which will be created if it does not yet exist).

### Building the benchmarks

The benchmark code can be built with CMake. Build the project here by running:
```sh
cmake .
cmake --build .
```
or alternatively by creating a separate build directory:
```sh
mkdir build
cmake -S . -B build
cmake --build build
```
The compiled binaries can be found in `bin/`.

## Benchmarks
### Compression

#### Generating DAODs with different compression settings

This must be done in an ATLAS Analysis release, e.g. on lxplus or with Docker.

N.B. The `AnalysisBase` release doesn't have access to all required dictionaries and therefore won't work! Use `AthAnalysis`.

To use docker, run the following command to mount the current directory, enable X11 forwarding and open an interactive shell:
```sh
docker run --net host -i -t -v $(pwd):/workdir -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY atlas/athanalysis
```
Make sure to run `source /release_setup.sh` each time you start the container.

To get read/write access to the `data` directory from within the container, run
```sh
sudo chown -R atlas:atlas data
```
in the container (change it back to the host user when you stop working in the container).

To create the differently compressed versions of a given (D)AOD, run
```sh
cd scripts
./recompress_daod <DAOD_PATH>
```

#### Running the benchmarks

Build the benchmarks using the instructions described above and run
```sh
./bin/bm_compression
```

#### Analysing the benchmarks
TODO
